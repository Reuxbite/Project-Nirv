---
// Image Gallery/Lightbox component for zooming and navigation
---

<div id="image-gallery-lightbox" class="hidden fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-4">
  <div class="relative w-full h-full flex items-center justify-center">
    <!-- Close button -->
    <button
      id="gallery-close"
      class="absolute top-4 right-4 text-white hover:text-blue-400 transition-colors z-51"
      aria-label="Close gallery"
    >
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

    <!-- Image container -->
    <div class="relative max-w-5xl w-full h-full flex items-center justify-center">
      <img
        id="gallery-image"
        src=""
        alt="Zoomed image"
        class="max-w-full max-h-full object-contain transition-transform duration-200"
      />
    </div>

    <!-- Zoom controls -->
    <div class="absolute bottom-4 left-4 flex gap-2">
      <button
        id="gallery-zoom-in"
        class="bg-slate-800 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors"
        aria-label="Zoom in"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
        </svg>
      </button>
      <button
        id="gallery-zoom-out"
        class="bg-slate-800 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors"
        aria-label="Zoom out"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
        </svg>
      </button>
      <span id="gallery-zoom-level" class="bg-slate-800 text-white px-4 py-2 rounded text-sm">100%</span>
    </div>

    <!-- Navigation arrows -->
    <button
      id="gallery-prev"
      class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-blue-400 transition-colors hidden"
      aria-label="Previous image"
    >
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>
    <button
      id="gallery-next"
      class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-blue-400 transition-colors hidden"
      aria-label="Next image"
    >
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
  </div>
</div>

<script>
  let currentZoom = 100;
  let isDragging = false;
  let dragStartX = 0;
  let dragStartY = 0;
  let offsetX = 0;
  let offsetY = 0;

  const lightbox = document.getElementById('image-gallery-lightbox');
  const galleryImage = document.getElementById('gallery-image') as HTMLImageElement;
  const closeBtn = document.getElementById('gallery-close');
  const zoomInBtn = document.getElementById('gallery-zoom-in');
  const zoomOutBtn = document.getElementById('gallery-zoom-out');
  const zoomLevel = document.getElementById('gallery-zoom-level');
  const prevBtn = document.getElementById('gallery-prev');
  const nextBtn = document.getElementById('gallery-next');

  function updateZoom() {
    if (galleryImage) {
      galleryImage.style.transform = `scale(${currentZoom / 100}) translate(${offsetX}px, ${offsetY}px)`;
      if (zoomLevel) {
        zoomLevel.textContent = `${currentZoom}%`;
      }
    }
  }

  function openGallery(imgElement: HTMLImageElement) {
    if (!lightbox || !galleryImage) return;
    
    currentZoom = 100;
    offsetX = 0;
    offsetY = 0;
    galleryImage.src = imgElement.src;
    lightbox.classList.remove('hidden');
    updateZoom();
    
    // Hide navigation buttons - only show single image
    if (prevBtn) prevBtn.classList.add('hidden');
    if (nextBtn) nextBtn.classList.add('hidden');
  }

  function closeGallery() {
    if (lightbox) {
      lightbox.classList.add('hidden');
      currentZoom = 100;
      offsetX = 0;
      offsetY = 0;
    }
  }

  // Event listeners
  if (closeBtn) closeBtn.addEventListener('click', closeGallery);
  if (lightbox) lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) closeGallery();
  });

  if (zoomInBtn) {
    zoomInBtn.addEventListener('click', () => {
      currentZoom = Math.min(300, currentZoom + 20);
      updateZoom();
    });
  }

  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      currentZoom = Math.max(50, currentZoom - 20);
      updateZoom();
    });
  }

  // Mouse wheel zoom
  if (lightbox) {
    lightbox.addEventListener('wheel', (e: WheelEvent) => {
      if (lightbox.classList.contains('hidden')) return;
      e.preventDefault();
      
      const zoomDelta = e.deltaY > 0 ? -20 : 20;
      currentZoom = Math.max(50, Math.min(300, currentZoom + zoomDelta));
      updateZoom();
    }, { passive: false });
  }

  // Mouse drag to pan
  if (galleryImage) {
    galleryImage.addEventListener('mousedown', (e: MouseEvent) => {
      isDragging = true;
      dragStartX = e.clientX - offsetX;
      dragStartY = e.clientY - offsetY;
      galleryImage.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', (e: MouseEvent) => {
      if (!isDragging || !lightbox || lightbox.classList.contains('hidden')) return;
      
      if (currentZoom > 100) {
        const maxOffsetX = (currentZoom - 100) * 2;
        const maxOffsetY = (currentZoom - 100) * 2;
        
        offsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, e.clientX - dragStartX));
        offsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, e.clientY - dragStartY));
        updateZoom();
      }
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      galleryImage.style.cursor = 'pointer';
    });
  }

  // Keyboard controls
  document.addEventListener('keydown', (e) => {
    if (!lightbox || lightbox.classList.contains('hidden')) return;
    
    switch (e.key) {
      case 'Escape':
        closeGallery();
        break;
      case '+':
      case '=':
        currentZoom = Math.min(300, currentZoom + 20);
        updateZoom();
        break;
      case '-':
        currentZoom = Math.max(50, currentZoom - 20);
        updateZoom();
        break;
    }
  });

  // Add click listeners to all content images
  function initializeGallery() {
    const contentImages = document.querySelectorAll('main img, article img, .prose img, .content img');
    contentImages.forEach((img: Element) => {
      if (img instanceof HTMLImageElement && !img.hasAttribute('data-no-gallery') && !img.hasAttribute('data-gallery')) {
        img.setAttribute('data-gallery', 'true');
        img.style.cursor = 'pointer';
        img.addEventListener('click', () => openGallery(img));
      }
    });
  }

  // Run immediately and also on DOMContentLoaded as fallback
  initializeGallery();
  document.addEventListener('DOMContentLoaded', initializeGallery);
  
  // Also observe for dynamically added images
  if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(() => {
      initializeGallery();
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>

<style>
  #image-gallery-lightbox {
    animation: fadeIn 0.2s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>
